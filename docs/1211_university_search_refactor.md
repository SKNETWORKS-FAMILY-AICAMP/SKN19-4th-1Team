# 대학/학과 검색 로직 SQL 마이그레이션 리포트

**작성일**: 2025-12-11
**작성자**: Antigravity (AI Assistant)
**관련 이슈**: 한양대학교 "컴퓨터소프트웨어학부" 검색 누락 버그 수정

## 1. 개요
대학 및 학과 검색 기능(`get_universities_by_department`)의 데이터 소스를 기존의 JSON 파일/VectorStore 기반에서 **SQL 데이터베이스(`Major` 테이블)** 기반으로 전면 교체하였습니다. 이를 통해 데이터의 정확성을 높이고, 유사 학과 검색을 위한 키워드 확장 로직을 도입하여 검색 품질을 개선했습니다.

## 2. 변경 배경
- **데이터 불일치**: 기존 시스템은 벡터 검색이나 별도의 JSON 파일을 사용하여, 최신 DB 데이터와 동기화되지 않는 문제가 있었습니다.
- **한양대학교 버그**: 사용자가 "컴퓨터공학과"를 검색했을 때, 한양대학교의 실제 학과명인 "컴퓨터소프트웨어학부"가 검색 결과에 포함되지 않는 문제가 발생했습니다.
- **검색 제한**: 기존 로직은 단순 매칭이나 벡터 유사도에 의존하여, "컴공" -> "컴퓨터소프트웨어학부"와 같은 파생 관계를 명확히 처리하지 못했습니다.

## 3. 주요 변경 사항

### 3.1 SQL 기반 검색 (`Major` 테이블 직접 조회)
- **Before**: `_lookup_major_by_name`, `_find_majors` 등 복잡한 헬퍼 함수를 통해 JSON/VectorStore 검색
- **After**: `backend.db.models.Major` 테이블을 직접 `LIKE` 쿼리로 조회.
- **이점**: DB에 저장된 가장 최신의, 권위 있는(Authoritative) 데이터를 보장.

### 3.2 키워드 확장 (Keyword Expansion)
"컴퓨터공학과"와 같이 일반적인 학과명을 검색했을 때, 대학별로 상이한 학과명(예: 컴퓨터소프트웨어학부, 컴퓨터과학과)을 모두 찾을 수 있도록 **Suffix Stripping** 로직을 추가했습니다.

**로직 예시**:
1. 사용자 검색어: "컴퓨터공학과"
2. 1차 검색: `LIKE %컴퓨터공학과%` -> "컴퓨터공학과" 이름을 가진 대학들 검색
3. Suffix 제거: "컴퓨터공학과" -> "공학과" 제거 -> **"컴퓨터"**
4. 2차 검색 (확장): `LIKE %컴퓨터%` -> **"컴퓨터소프트웨어학부"**, "컴퓨터과학과" 등 포함
5. 결과 통합: 1차, 2차 결과 중복 제거 후 합산

### 3.3 검색 결과 제한 확대
- `MAX_UNIVERSITY_RESULTS`를 기존 **50개**에서 **200개**로 상향 조정했습니다.
- **이유**: "컴퓨터"와 같은 광범위한 키워드로 검색 시, 관련 대학이 매우 많아 50개 제한으로는 한양대와 같이 리스트 뒤쪽에 위치한 대학이 잘릴 수 있음.

## 4. 검증 결과 (`test_llm.py`)

`python test_llm.py` 실행을 통해 다음 사항을 검증했습니다.

- **한양대 케이스**: "컴퓨터공학과" 검색 시, 결과 리스트에 **"한양대학교" (학과명: "컴퓨터소프트웨어학부")**가 포함됨을 확인.
- **입시 정보**: SQL DB에 저장된 URL 등의 정보가 정상적으로 반환됨.

## 5. 향후 계획
- **동의어 사전(Thesaurus) 구축**: Suffix Stripping 외에도, "기계" <-> "메카트로닉스" 와 같은 의미적 동의어 관계를 DB화하여 검색 로직에 반영할 예정.
- **검색 성능 최적화**: 데이터 양이 늘어날 경우를 대비해 Full-Text Search 도입 고려.
