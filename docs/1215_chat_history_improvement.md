# 2025-12-15 Chat History Loading and Auto-save Improvement

## 개요

대화 목록 불러오기 시 발생하는 불필요한 "저장하시겠습니까?" 프롬프트를 제거하고, 자연스러운 대화 전환 경험을 제공하도록 개선했습니다. 또한, 모든 대화 턴(Turn)이 자동으로 서버에 저장됨을 확인했습니다.

## 주요 변경 사항

### 1. 대화 불러오기 로직 개선 (`chat.js`)

- **변경 전**: 대화 목록 클릭 시 `confirm` 창을 통해 현재 대화 저장 여부를 물어봄. "예" 클릭 시 중복 대화가 생성되는 문제 발생.
- **변경 후**: `confirm` 창을 제거. 대화 목록 클릭 시 즉시 해당 대화를 불러오도록 변경.
- **근거**: 백엔드 API (`chat_api`)가 대화 진행 시마다 메시지를 실시간으로 DB에 저장하고 있으므로, 별도의 클라이언트 측 수동 저장 절차가 불필요함.

### 2. 자동 저장 (Auto-save)

- 백엔드 `StreamingHttpResponse` 로직 내에서 사용자 질문과 AI 답변이 생성될 때마다 `Message` 모델을 통해 DB에 적재됨을 확인.
- 별도의 추가 구현 없이 기존 아키텍처가 요구사항을 충족함을 확인.

## 결과

- 사용자는 대화 목록 사이를 팝업 없이 자유롭게 이동할 수 있음.
- 중복된 "새 대화" 로그가 생성되지 않음.

### 3. 답변 중복 버그 수정 (`backend/graph/nodes.py`)

- **증상**: 대화 초반에 멘트가 두 번 반복해서 출력되는 현상 (예: "안녕하세요... 안녕하세요...").
- **원인**: `agent_node` 내부에서 LLM이 툴을 호출하지 않을 경우 강제로 재시도(Retry)하는 로직이 있었음. 스트리밍 모드에서는 첫 번째 시도(실패)와 두 번째 시도(성공)의 텍스트가 모두 클라이언트로 전송되어 중복이 발생함.
- **조치**: 내부 재시도 로직을 제거하고, 시스템 프롬프트를 통해 툴 사용을 유도하도록 변경. 이로써 불필요한 중복 생성이 사라짐.

### 4. 온보딩 내역 저장 및 목록 연동

- **증상**: "추천 시작"으로 온보딩을 완료한 후, 새로고침하면 내용이 사라지거나 과거 대화 목록에 즉시 나타나지 않음.
- **원인**: 온보딩 API가 추천 결과만 저장하고 대화 내역(`History`)은 저장하지 않았으며, 클라이언트도 완료 시점에 Conversation ID 동기화가 되지 않음.
- **조치**:
  - `onboarding_api`(`views.py`)가 대화 내역(`history`)을 입력받아 `Message`로 저장하도록 개선.
  - `finishOnboarding`(`chat.js`)에서 대화 내역을 전송하고, 반환된 `conversation_id`를 즉시 로컬 상태에 반영.
  - 로그인 유저 재방문 시 안내 문구를 "이전 대화 불러오기" 가이드로 변경.

### 5. 대화방 중복 생성 버그 수정

- **증상**: 대화 내역이 없는 상태에서 첫 메시지를 보냈는데 대화방이 2개 생성됨.
- **원인**: 프론트엔드에서 전송 버튼/엔터 키 입력 시 중복 제출(Double Submission)이 발생하여, 동시에 두 개의 '새 대화 생성' 요청이 백엔드로 전송됨. 백엔드는 각각의 요청에 대해 새로운 대화방을 생성함.
- **조치**: `chat.js`의 `handleSubmit` 함수에 `isProcessing` 플래그(Lock)를 도입하여, 이미 요청 처리 중일 경우 추가 입력을 차단하도록 수정.

### 6. 온보딩 시 대화방 중복 생성 수정

- **증상**: "추천 시작"으로 온보딩을 진행하면 기존 대화방은 유지된 채, 온보딩 내용이 포함된 새로운 대화방이 또 하나 생성됨(내용 중복).
- **원인**: `onboarding_api`가 항상 새로운 `Conversation`을 생성하도록 로직이 작성되어 있었음. 기존 대화(Intro 등)가 있는 상태에서 온보딩을 시작하면 별개의 세션으로 분리됨.
- **조치**:
  - `onboarding_api`(`views.py`)가 `conversation_id`를 입력받도록 수정.
  - 기존 ID가 있으면 해당 대화방을 재사용하고, 기존 메시지 이후의 내역만 `Message`로 추가 저장하도록 로직 개선.
  - `chat.js`에서 `finishOnboarding` 호출 시 `currentConversationId`를 함께 전송.

### 7. '새 채팅' 버튼 클릭 시 대화 목록 중복 생성 수정

- **증상**: 대화를 진행하다가 "새 채팅" 버튼을 누르면, 방금 진행하던 대화가 목록에 2개로 중복되어 나타남.
- **원인**: `resetChat` 함수가 실행될 때 `/api/chat/save`를 호출하여 현재 대화 내역을 '새로운 대화'로 저장함. 그러나 일반적인 대화(`handleChatInput`)는 이미 실시간으로 백엔드에 저장되고 있으므로, `resetChat`의 저장은 불필요한 중복 저장이 됨.
- **조치**: `resetChat` 함수에서 `currentConversationId`가 있을 경우(이미 백엔드와 연동된 대화일 경우) `/api/chat/save` 호출을 건너뛰도록 수정.
